#!/bin/sh
# Amnezia-UI for ASUSWRT-Merlin
# AmneziaWG (WireGuard with DPI bypass) addon
# Provides command-line and web interface management with router ASP integration
VERSION="3.5.1"
BASE_DIR="/jffs/addons/amneziaui"
CONFIG_DIR="$BASE_DIR/configs"
WEB_DIR="$BASE_DIR/web"
CUSTOM_DIR="/jffs/amneziaui_custom"
PID_FILE="/tmp/amneziaui.pid"
LOG_FILE="/tmp/amneziaui.log"
WEB_PID="/tmp/amneziaui_web.pid"
WEB_PORT="8080"
ASP_DIR="$WEB_DIR/asp"
ASP_INDEX="$ASP_DIR/index.asp"
OVERLAY_DIR="/jffs/overlay/www"
STOCK_WWW="/www"
VPN_ASP="Advanced_VPN_Content.asp"
FIREWALL_ASP="Advanced_Firewall_Content.asp"
VPN_TABS_ASP="VPN.asp"
USER_ASP_NAME="user_amneziaui.asp"
USER_ASP_PATH="$STOCK_WWW/$USER_ASP_NAME"
# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color
log() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"; }
print_status() {
    case $1 in
        error) echo -e "${RED}[ERROR]${NC} $2" ;;
        success) echo -e "${GREEN}[OK]${NC} $2" ;;
        warning) echo -e "${YELLOW}[WARNING]${NC} $2" ;;
        info|*) echo "[INFO] $2" ;;
    esac
    log "$1: $2"
}
check_merlin() {
    if [ -f /jffs/.asusrouter ]; then
        print_status success "ASUSWRT-Merlin compatibility confirmed (marker found)"; return 0; fi
    if uname -a 2>/dev/null | grep -iq merlin; then
        print_status info "Merlin detected, creating compatibility marker"
        touch /jffs/.asusrouter 2>/dev/null && { print_status success "Compatibility marker created successfully"; return 0; }
    fi
    print_status warning "ASUSWRT-Merlin firmware not detected"
    print_status info "Continuing anyway - to force, run: touch /jffs/.asusrouter"; return 0
}
ensure_dirs() {
    mkdir -p "$CONFIG_DIR" "$WEB_DIR" "$ASP_DIR" "$CUSTOM_DIR"
}
# ---------------- Mini-UI (userX.asp) creation & integration ----------------
user_asp_template() {
    cat << 'EOF'
<% nvram("productid"); %>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Amnezia-UI — mini UI</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#0b1220;color:#e6edf3}
    header{background:#161b22;padding:12px 16px;border-bottom:1px solid #30363d}
    h1{font-size:18px;margin:0}
    .wrap{padding:16px}
    .card{background:#0d1117;border:1px solid #30363d;border-radius:8px;padding:16px}
    .btn{display:inline-block;background:#238636;color:#fff;padding:10px 14px;border-radius:6px;text-decoration:none}
    .btn.secondary{background:#0969da}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    iframe{width:100%;height:70vh;border:1px solid #30363d;border-radius:6px;background:#fff}
    .hint{color:#8b949e;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <header><h1>Amnezia-UI — mini UI</h1></header>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <a class="btn" href="/user_amneziaui.asp?open=ui">Open embedded UI</a>
        <a class="btn secondary" target="_blank" href="http://<% nvram("lan_ipaddr"); %>:8080/">Open full UI (new tab)</a>
      </div>
      <p class="hint">Service must be running on port 8080. Start via amnezia-ui script if needed.</p>
    </div>
    <div class="card" id="embed" style="margin-top:14px;">
      <iframe title="Amnezia-UI" src="http://<% nvram("lan_ipaddr"); %>:8080/"></iframe>
    </div>
  </div>
</body>
</html>
EOF
}
create_user_asp() {
    local target="${USER_ASP_PATH}"
    mkdir -p "$STOCK_WWW" "$OVERLAY_DIR"
    # Prefer overlay to avoid touching stock directly
    if [ -d "$OVERLAY_DIR" ]; then
        target="$OVERLAY_DIR/$USER_ASP_NAME"
    fi
    if [ -f "$target" ]; then
        print_status info "Mini-UI ASP already exists: $target"; return 0; fi
    user_asp_template > "$target" && {
        chmod 644 "$target"
        print_status success "Mini-UI ASP created: $target"
    } || {
        print_status error "Failed to create $target"; return 1
    }
}
ensure_home_link() {
    # Inject link into index.asp via overlay when possible
    local idx_src="$STOCK_WWW/index.asp"
    local idx_ovl="$OVERLAY_DIR/index.asp"
    mkdir -p "$OVERLAY_DIR"
    if [ -f "$idx_src" ] && [ ! -f "$idx_ovl" ]; then cp -f "$idx_src" "$idx_ovl"; fi
    if [ -f "$idx_ovl" ]; then
        if ! grep -q "user_amneziaui.asp" "$idx_ovl" 2>/dev/null; then
            sed -i '/<\/body>/i \<!-- Amnezia-UI link injected -->\n<li style="list-style:none;margin:6px 0"><a href="/user_amneziaui.asp">Amnezia-UI</a></li>' "$idx_ovl" && \
            print_status success "Homepage link injected (overlay)"
        else
            print_status info "Homepage link already present"
        fi
    else
        print_status warning "index.asp overlay not available; skipping homepage link"
    fi
}
ensure_vpn_fw_links() {
    local files="${VPN_ASP} ${FIREWALL_ASP}"
    for f in $files; do
        local src="$STOCK_WWW/$f"
        local ovl="$OVERLAY_DIR/$f"
        [ -f "$src" ] || { print_status info "$f not found on this model"; continue; }
        [ -f "$ovl" ] || cp -f "$src" "$ovl"
        if ! grep -q "user_amneziaui.asp" "$ovl" 2>/dev/null; then
            sed -i '/<\/body>/i \<!-- Amnezia-UI quick entry -->\n<div style="margin:10px 0;">\n  <a href="/user_amneziaui.asp" style="color:#0969da">Open Amnezia-UI mini page</a>\n</div>' "$ovl" && \
            print_status success "Injected link into $f (overlay)"
        else
            print_status info "$f already has Amnezia link"
        fi
    done
}
# --------- NEW: VPN tab list integration (VPN.asp submenu injection) ---------
ensure_vpn_tabs_entry() {
    local tabs_src="$STOCK_WWW/$VPN_TABS_ASP"
    local tabs_ovl="$OVERLAY_DIR/$VPN_TABS_ASP"
    mkdir -p "$OVERLAY_DIR"
    if [ ! -f "$tabs_src" ]; then
        print_status info "$VPN_TABS_ASP not found; skipping VPN tab injection"; return 0
    fi
    [ -f "$tabs_ovl" ] || cp -f "$tabs_src" "$tabs_ovl"
    # Try common Merlin tab lists: look for submenu UL/LI with OpenVPN/WireGuard etc
    if ! grep -q "user_amneziaui.asp" "$tabs_ovl" 2>/dev/null; then
        # Strategy A: Insert after WireGuard tab
        sed -i '/WireGuard/ { n; a \
<li><a href="/user_amneziaui.asp">Amnezia-UI</a></li>' "$tabs_ovl" 2>/dev/null || true
        # Strategy B: If not inserted, try to append within a known submenu container
        if ! grep -q "Amnezia-UI" "$tabs_ovl"; then
            sed -i '0,/<\/ul>/ s//\n<li><a href="\/user_amneziaui.asp">Amnezia-UI<\/a><\/li>\n&/' "$tabs_ovl" 2>/dev/null || true
        fi
        if grep -q "Amnezia-UI" "$tabs_ovl"; then
            print_status success "Injected Amnezia-UI entry into VPN tab list (overlay)"
        else
            print_status warning "Could not detect submenu markup; skipping VPN tab injection"
        fi
    else
        print_status info "VPN tab already contains Amnezia-UI entry"
    fi
}
# ---------------- Web server helpers (existing) ----------------
start_web_server(){
    if [ -f "$WEB_PID" ] && kill -0 "$(cat "$WEB_PID" 2>/dev/null)" 2>/dev/null; then
        print_status info "Web already running on $WEB_PORT"; return 0; fi
    busybox httpd -f -p "$WEB_PORT" -h "$WEB_DIR" & disown; echo $! > "$WEB_PID" && \
      print_status success "Started web on port $WEB_PORT" || \
      print_status error "Failed to start web server"
}
stop_web_server(){ if [ -f "$WEB_PID" ]; then kill $(cat "$WEB_PID" 2>/dev/null) 2>/dev/null; rm -f "$WEB_PID"; print_status success "Web server stopped"; else print_status info "Web server not running"; fi }
web_status(){ if [ -f "$WEB_PID" ] && kill -0 $(cat "$WEB_PID" 2>/dev/null) 2>/dev/null; then echo running; else echo stopped; fi }
# ---------------- Install/Uninstall ----------------
install_addon(){
    check_merlin
    ensure_dirs
    create_user_asp
    ensure_home_link
    ensure_vpn_fw_links
    ensure_vpn_tabs_entry
    print_status success "Mini-UI integration completed (including VPN tab entry)"
}
uninstall_addon(){
    rm -f "$OVERLAY_DIR/$USER_ASP_NAME" "$STOCK_WWW/$USER_ASP_NAME" 2>/dev/null || true
    print_status success "Mini-UI page removed (if existed). Overlay customizations preserved"
}
# ---------------- CLI and helpers ----------------
stop_interface(){ iface="${1:-amnezia0}"; print_status info "Stop $iface"; }
start_interface(){ iface="${1:-amnezia0}"; print_status info "Start $iface"; }
restart_interface(){ iface="${1:-amnezia0}"; stop_interface "$iface"; start_interface "$iface"; }
add_config(){ cfg="$1"; [ -f "$cfg" ] || { print_status error "Config not found"; exit 1; }; cp -f "$cfg" "$CONFIG_DIR"/; print_status success "Config added"; }
show_status(){
    echo "Amnezia-UI v$VERSION"
    echo "Web: $(web_status) on port $WEB_PORT"
    echo "Config dir: $CONFIG_DIR"
    echo "Custom dir: $CUSTOM_DIR"
}
usage(){ cat << EOF
Amnezia-UI v$VERSION - AmneziaWG Management Tool
Usage: $0 [command]
  install | uninstall
  start|stop|restart [iface]
  status
  add <config_file>
  web start|stop|status
  ui overlay|patch
EOF
}
main(){
 case "$1" in
   install) install_addon ;;
   uninstall) uninstall_addon ;;
   start) start_interface "$2" ;;
   stop) stop_interface "$2" ;;
   restart) restart_interface "$2" ;;
   add) add_config "$2" ;;
   status) show_status ;;
   web)
     case "$2" in
       start) start_web_server ;;
       stop) stop_web_server ;;
       status) web_status ;;
       *) print_status error "Invalid web command"; exit 1 ;;
     esac ;;
   ui)
     case "$2" in
       overlay) ensure_home_link; ensure_vpn_fw_links; ensure_vpn_tabs_entry ;;
       patch) ensure_home_link; ensure_vpn_fw_links; ensure_vpn_tabs_entry ;;
       *) print_status error "Invalid ui command"; exit 1 ;;
     esac ;;
   ""|help|-h|--help) usage ;;
   *) print_status error "Unknown command: $1"; usage; exit 1 ;;
 esac
}
main "$@"
