#!/bin/sh
# Amnezia-UI for ASUSWRT-Merlin
# AmneziaWG (WireGuard with DPI bypass) addon
# Provides command-line and web interface management
VERSION="3.4.0"
BASE_DIR="/jffs/addons/amneziaui"
CONFIG_DIR="$BASE_DIR/configs"
WEB_DIR="$BASE_DIR/web"
CUSTOM_DIR="/jffs/amneziaui_custom"
PID_FILE="/tmp/amneziaui.pid"
LOG_FILE="/tmp/amneziaui.log"
WEB_PID="/tmp/amneziaui_web.pid"
WEB_PORT="8080"
ASP_DIR="$WEB_DIR/asp"
ASP_INDEX="$ASP_DIR/index.asp"
# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color
log() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"; }
print_status() {
    case $1 in
        error) echo -e "${RED}[ERROR]${NC} $2" ;;
        success) echo -e "${GREEN}[OK]${NC} $2" ;;
        warning) echo -e "${YELLOW}[WARNING]${NC} $2" ;;
        info|*) echo "[INFO] $2" ;;
    esac
    log "$1: $2"
}
check_merlin() {
    if [ -f /jffs/.asusrouter ]; then
        print_status success "ASUSWRT-Merlin compatibility confirmed (marker found)"; return 0; fi
    if uname -a 2>/dev/null | grep -iq merlin; then
        print_status info "Merlin detected in system info, creating compatibility marker"
        touch /jffs/.asusrouter 2>/dev/null && { print_status success "Compatibility marker created successfully"; return 0; }
    fi
    print_status warning "ASUSWRT-Merlin firmware not detected"
    print_status info "Continuing anyway - to force, run: touch /jffs/.asusrouter"; return 0
}
ensure_dirs() {
    mkdir -p "$CONFIG_DIR" "$WEB_DIR" "$ASP_DIR"
}
write_asp_page() {
    mkdir -p "$ASP_DIR"
    cat > "$ASP_INDEX" << 'EOF'
<% nvram("productid"); %>
<html>
<head>
<meta http-equiv="refresh" content="5">
<title>Amnezia-UI</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#0b1220;color:#e8eefc;margin:0;padding:16px}
.card{background:#121a2b;border:1px solid #1d2a44;border-radius:8px;padding:16px;max-width:720px}
.btn{display:inline-block;padding:10px 14px;background:#3b82f6;color:#fff;text-decoration:none;border-radius:6px;margin-right:8px}
.badge{padding:4px 8px;border-radius:12px}
.badge.ok{background:#16a34a}.badge.fail{background:#dc2626}.badge.warn{background:#f59e0b}
.small{opacity:.8;font-size:12px}
</style>
<script>
async function ping(url){try{const r=await fetch(url,{method:'GET'});return r.ok}catch(e){return false}}
async function go(){const alive=await ping('/status');const el=document.getElementById('ws');el.textContent=alive?'RUNNING':'STOPPED';el.className='badge '+(alive?'ok':'fail');}
window.addEventListener('load',go);
</script>
</head>
<body>
<div class="card">
  <h2>Amnezia-UI (AmneziaWG)</h2>
  <p>Service status: <span id="ws" class="badge warn">CHECKING</span></p>
  <p>
    <a class="btn" href="/">Open Web UI</a>
    <a class="btn" href="http://router.asus.com:8080/">Open on router.asus.com</a>
  </p>
  <p class="small">This page auto-refreshes every 5 seconds.</p>
</div>
</body>
</html>
EOF
}
start_web_server() {
    # very small busybox httpd with static asp dir
    ensure_dirs
    write_asp_page
    if [ -f "$WEB_PID" ] && kill -0 "$(cat "$WEB_PID" 2>/dev/null)" 2>/dev/null; then
        print_status info "Web already running on port $WEB_PORT"; return 0; fi
    if command -v httpd >/dev/null 2>&1; then
        httpd -p "$WEB_PORT" -h "$WEB_DIR" &
        echo $! > "$WEB_PID"
        print_status success "Web UI started on port $WEB_PORT"
    else
        print_status error "busybox httpd not found"
        return 1
    fi
}
stop_web_server() {
    if [ -f "$WEB_PID" ]; then
        kill "$(cat "$WEB_PID")" 2>/dev/null || true
        rm -f "$WEB_PID"
        print_status success "Web UI stopped"
    else
        # try killall as fallback
        killall httpd 2>/dev/null || true
    fi
}
web_status() {
    if [ -f "$WEB_PID" ] && kill -0 "$(cat "$WEB_PID" 2>/dev/null)" 2>/dev/null; then
        echo "running"; return 0; else echo "stopped"; return 1; fi
}
install_addon() {
    check_merlin
    ensure_dirs
    write_asp_page
    # create hook readme similar to XRAYUI
    mkdir -p "$BASE_DIR/hook"
    cat > "$BASE_DIR/hook/README.md" << 'EOF'
Amnezia-UI Router UI integration hooks
- Place asp/index.asp into /jffs/addons/amneziaui/web/asp/
- Add a menu entry in ASUSWRT using /jffs/scripts/init-start or services-start by appending to /www/Advanced_VPN_Content.asp via a symlink or using XRAYUI-style overlay.
- Example temporary menu injection (non-persistent):
  sed -i 's|id="VPNMenu"|id="VPNMenu"><li><a href="/amneziaui/asp/index.asp">Amnezia-UI</a></li>|' /www/Advanced_VPN_Content.asp
- For persistent method across reboots/firmware, see repository README.
EOF
    # enable autostart
    mkdir -p /jffs/scripts
    if ! grep -q amneziaui /jffs/scripts/services-start 2>/dev/null; then
        {
          echo "#!/bin/sh"
          echo "$BASE_DIR/amnezia-ui web start >/dev/null 2>&1 &"
        } >> /jffs/scripts/services-start
        chmod +x /jffs/scripts/services-start
    fi
    print_status success "Addon installed"
}
uninstall_addon() {
    stop_web_server
    rm -rf "$BASE_DIR"
    sed -i '/amneziaui/d' /jffs/scripts/services-start 2>/dev/null || true
    print_status success "Addon uninstalled"
}
start_interface(){ iface="${1:-amnezia0}"; print_status info "Start $iface"; }
stop_interface(){ iface="${1:-amnezia0}"; print_status info "Stop $iface"; }
restart_interface(){ iface="${1:-amnezia0}"; stop_interface "$iface"; start_interface "$iface"; }
add_config(){ cfg="$1"; [ -f "$cfg" ] || { print_status error "Config not found"; exit 1; }; cp -f "$cfg" "$CONFIG_DIR"/; print_status success "Config added"; }
show_status(){
    echo "Amnezia-UI v$VERSION"
    echo "Web: $(web_status) on port $WEB_PORT"
    echo "Config dir: $CONFIG_DIR"
    echo "Custom dir: $CUSTOM_DIR"
}
usage(){ cat << EOF
Amnezia-UI v$VERSION - AmneziaWG Management Tool
Usage: $0 [command]
  install | uninstall
  start|stop|restart [iface]
  status
  add <config_file>
  web start|stop|status
EOF
}
main(){
 case "$1" in
   install) install_addon ;;
   uninstall) uninstall_addon ;;
   start) start_interface "$2" ;;
   stop) stop_interface "$2" ;;
   restart) restart_interface "$2" ;;
   add) add_config "$2" ;;
   status) show_status ;;
   web)
     case "$2" in
       start) start_web_server ;;
       stop) stop_web_server ;;
       status) web_status ;;
       *) print_status error "Invalid web command"; exit 1 ;;
     esac ;;
   ""|help|-h|--help) usage ;;
   *) print_status error "Unknown command: $1"; usage; exit 1 ;;
 esac
}
main "$@"
